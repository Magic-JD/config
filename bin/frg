#!/bin/bash

export DELTA_FEATURES=+file-decoration-style=none

FZF_DEFAULT_OPTS="$FZF_DEFAULT_OPTS --exact --ansi --delimiter=':' --with-nth=3.. --preview 'bat --style=header,grid --color=always {1} --highlight-line {2}' --preview-window '~4,+{2}-3:top'"

if [[ $1 ]]; then
	RG_RESULT=$(rg --line-number --with-filename . -g "$1" --color=always | delta | fzf)
else
	RG_RESULT=$(rg --line-number --with-filename . --color=always | delta | fzf)
fi

FIRST_LINE=$(echo "$RG_RESULT" | awk 'NR==1 {print; exit}')
OTHER_LINES=$(echo "$RG_RESULT" | awk 'NR>1')

if [[ -n $FIRST_LINE ]]; then
    if [[ -n $OTHER_LINES ]]; then
        echo $(echo "$FIRST_LINE" | awk -F: '{print "+"$2" "$1}') $(echo "$OTHER_LINES" | awk -F: '{print " -c \"e "$1" | "$2"\""}' | tr -d '\n') | xargs $EDITOR
    else
        $EDITOR $(echo "$FIRST_LINE" | awk -F: '{print "+"$2" "$1}')
    fi
fi

